<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, user-scalable=no" />
    <meta charset="utf-8" />
    <script src="Scripts/jquery-3.6.0.js"></script>
    <script src="Scripts/jquery-ui.js"></script>
    <script src="Scripts/bootstrap.js"></script>
    <link href="Content/jquery-ui.css" rel="stylesheet" />
    <link href="Content/bootstrap.rtl.css" rel="stylesheet" />
    <link href="Content/font-awesome.css" rel="stylesheet" />
    <title></title>
</head>
<body style="direction:rtl; background-color:#f0f0f0;">
    <script>
        var data = {
            Timesheets: [1, 5],
            Courses: [{
                Id: 1,
                Title: "برنامه سازی 1",
                Credit: 3,
                Cost: 1580000,
                PermitType: 0, // 0 = allowed   1 = passed     2 = pre_requirement
                Professors: [
                    {
                        Id: 1,
                        Title: "استاد مرتضوی بزرگ",
                        Timesheets: [{
                            Id: 1,
                            TimeType: 0,
                            WeekDay: 0
                        }, {
                            Id: 2,
                            TimeType: 0,
                            WeekDay: 2
                        }]
                    }, {
                        Id: 2,
                        Title: "استاد کاظمی",
                        Timesheets: [{
                            Id: 3,
                            TimeType: 1,
                            WeekDay: 0
                        }, {
                            Id: 4,
                            TimeType: 1,
                            WeekDay: 1
                        }]
                    }
                ]
            }, {
                Id: 2,
                Title: "مدار منطقی",
                Credit: 3,
                Cost: 1580000,
                PermitType: 0, // 0 = allowed   1 = passed     2 = pre_requirement
                Professors: [
                    {
                        Id: 1,
                        Title: "استاد مرتضوی بزرگ",
                        Timesheets: [{
                            Id: 5,
                            TimeType: 1,
                            WeekDay: 0
                        }, {
                            Id: 6,
                            TimeType: 1,
                            WeekDay: 2
                        }]
                    }, {
                        Id: 2,
                        Title: "استاد کاظمی",
                        Timesheets: [{
                            Id: 3,
                            TimeType: 0,
                            WeekDay: 0
                        }, {
                            Id: 2,
                            TimeType: 0,
                            WeekDay: 1
                        }]
                    }
                ]
            }
            ]
        };
        
    </script>
    <div class="container border mt-3 pt-3" style="background-color:#fff;">
        <div class="row">
            <div class="col-sm-3">
                <div courses></div>
            </div>
            <div class="col-sm-9">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th></th>
                            <th>8-10</th>
                            <th>10-12</th>
                            <th>12-14</th>
                            <th>14-16</th>
                            <th>16-18</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr data-id="0">
                            <td>شنبه</td>
                            <td data-id="0"><span></span></td>
                            <td data-id="1"><span></span></td>
                            <td data-id="2"><span></span></td>
                            <td data-id="3"><span></span></td>
                            <td data-id="4"><span></span></td>
                        </tr>
                        <tr data-id="1">
                            <td>یکشنبه</td>
                            <td data-id="0"><span></span></td>
                            <td data-id="1"><span></span></td>
                            <td data-id="2"><span></span></td>
                            <td data-id="3"><span></span></td>
                            <td data-id="4"><span></span></td>
                        </tr>
                        <tr data-id="2">
                            <td>دوشنبه</td>
                            <td data-id="0"><span></span></td>
                            <td data-id="1"><span></span></td>
                            <td data-id="2"><span></span></td>
                            <td data-id="3"><span></span></td>
                            <td data-id="4"><span></span></td>
                        </tr>
                        <tr data-id="3">
                            <td>سه شنبه</td>
                            <td data-id="0"><span></span></td>
                            <td data-id="1"><span></span></td>
                            <td data-id="2"><span></span></td>
                            <td data-id="3"><span></span></td>
                            <td data-id="4"><span></span></td>
                        </tr>
                        <tr data-id="4">
                            <td>چهارشنبه</td>
                            <td data-id="0"><span></span></td>
                            <td data-id="1"><span></span></td>
                            <td data-id="2"><span></span></td>
                            <td data-id="3"><span></span></td>
                            <td data-id="4"><span></span></td>
                        </tr>
                        <tr data-id="5">
                            <td>پنجشنبه</td>
                            <td data-id="0"><span></span></td>
                            <td data-id="1"><span></span></td>
                            <td data-id="2"><span></span></td>
                            <td data-id="3"><span></span></td>
                            <td data-id="4"><span></span></td>
                        </tr>
                        <tr data-id="6">
                            <td>جمعه</td>
                            <td data-id="0"><span></span></td>
                            <td data-id="1"><span></span></td>
                            <td data-id="2"><span></span></td>
                            <td data-id="3"><span></span></td>
                            <td data-id="4"><span></span></td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <th colspan="3" total-credit>جمع واحد: <span>0</span></th>
                            <th colspan="3" total-cost>مبلغ شهریه: <span>0</span></th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
    <script>
        $(document).ready(function () {
            var currencyFormat = new Intl.NumberFormat({ style: 'currency' });
            var coursesDiv = $("div[courses]");
            $(data.Courses).each(function () {
                var course = this;
                $(coursesDiv).append(`<div data-id="${course.Id}" data-permit="${this.PermitType}"><span title>${this.Title}</span><br/><span credit>${this.Credit} واحد</span><span cost>${currencyFormat.format(this.Cost)} ریال</span></div>`);
            });
            $(coursesDiv).droppable({
                drop: function (a, b) {
                    $(b.helper[0]).removeAttr("landed").css({ "display": "inherit", "top": 0, "left": 0 });
                    var d = data.Courses.find(x => x.Id == $(b.helper[0]).data("id"));
                    d.Time = null;
                    d.Day = null;
                    setTimeout(function () {
                        $(data.Courses).each(function () {
                            correctCoursePosition(this.Id);
                        });
                    }, 40);
                    fillFooter();
                }
            }).children().each(function () {
                course = this;
                $(course).draggable({
                    classes: {
                        "ui-droppable-active": "ui-state-highlight"
                    },
                    revert: "invalid",
                    stop: function (a, b) {
                        var d = data.Courses.find(x => x.Id == $(b.helper[0]).data("id"));
                        $(d.Professors).each(function () {
                            var prof = this;
                            $(prof.Timesheets).each(function () {
                                t = this;
                                var sel = `table > tbody > tr[data-id="${t.WeekDay}"] > td[data-id="${t.TimeType}"]`;
                                $(sel).css("background-color", "#fff").children("span").text('');
                            });
                        });
                        return true;
                    },
                    start: function (a, b) {
                        var d = data.Courses.find(x => x.Id == $(b.helper[0]).data("id"));
                        d.Professors.sort();
                        for (var pi in d.Professors) {
                            var prof = d.Professors[pi];
                            var ch = (10 + ((pi * 7) % 5)).toString(16);
                            var color = "#ffaaaa";
                            if (pi % 3 == 0)
                                color = `#${ch}${ch}ffee`;
                            else if (pi % 3 == 1)
                                color = `#eeff${ch}${ch}`;
                            $(prof.Timesheets).each(function () {
                                t = this;
                                var sel = `table > tbody > tr[data-id="${t.WeekDay}"] > td[data-id="${t.TimeType}"]`;
                                $(sel).css("background-color", color).data("professorid", prof.Id).children("span").text(prof.Title);
                                $(sel).droppable({
                                    accept: function (a) {
                                        var c = data.Courses.find(x => x.Time == $(this).data("id") && x.Day == $(this).closest("tr").data("id"));
                                        if (c != null && c.Id != d.Id) {
                                            return false;
                                        }
                                        if (!$(a).is(`div[data-id="${d.Id}"]`))
                                            return false;
                                        return true;
                                    },
                                    drop: function (a, b) {
                                        var td = this;
                                        var d = data.Courses.find(x => x.Id == $(b.helper[0]).data("id"));
                                        d.Time = $(this).data("id");
                                        d.Day = $(this).closest("tr").data("id");
                                        $(b.helper[0]).children("span[professor]").remove();
                                        $(b.helper[0]).append(`<span professor>${$(this).children("span").text()}</span>`);
                                        $(b.helper[0]).attr("landed", "landed").css("display", "inline-table").data("time", $(this).data("id")).data("day", $(this).closest("tr").data("id"));
                                        setTimeout(function () {
                                            $(data.Courses).each(function () {
                                                correctCoursePosition(this.Id);
                                            });
                                        }, 40);
                                        fillFooter();
                                    }
                                });
                            });
                        }
                    }
                });
            });
        });
        function correctCoursePosition(courseId) {
            var course = $(`[courses] > div[data-id="${courseId}"]`);
            if ($(course).is("[landed]")) {
                var td = $(`table > tbody > tr[data-id="${$(course).data("day")}"] > td[data-id="${$(course).data("time")}"]`);
                var top = $(td).offset().top - $(course).offset().top + parseInt($(course).css("top")) + ($(td).height() - $(course).height()) / 2;
                var left = $(td).offset().left - $(course).offset().left + parseInt($(course).css("left")) + ($(td).width() - $(course).width()) / 2;
                $(course).css({ "top": top + "px", "left": left + "px" });
            } else {
                $(course).css({ "top": 0, "left": 0 });
            }
        }
        function fillFooter() {
            var totalCredit = 0;
            var totalCost = 0;
            var currencyFormat = new Intl.NumberFormat({ style: 'currency' });
            $(data.Courses).each(function () {
                if (this.Time != null && this.Day != null) {
                    totalCredit += this.Credit;
                    totalCost += this.Cost;
                }
            });
            $("table > tfoot [total-credit] span").text(totalCredit);
            $("table > tfoot [total-cost] span").text(currencyFormat.format(totalCost));
        }
    </script>
    <style>
        table > tbody > tr > td[data-id] {
            max-width: 1px;
            min-width: 1%;
        }
            table > tbody > tr > td[data-id] > span {
                font-size:small;
                height: 70px;
                display:block;
            }
        [courses] {
            border: 1px solid #ddd;
        }
        [courses] > div {
            border: 1px solid #ddd;
            padding: 5px 10px;
            white-space:nowrap;
        }
            [courses] > div[data-permit="0"]{
                background-color: #fff;
            }
                [courses] > div[data-permit="0"]:hover {
                    box-shadow: 2px 2px 4px #ddd;
                    cursor: grab;
                    user-select: none;
                    z-index:1;
                }
            [courses] > div[data-permit="1"] {
                background-color: #f5f5f5;
                border-color: #f5f5f5;
            }
            [courses] > div[data-permit="2"] {
                background-color: #f5e0e0;
                border-color: #f5e0e0;
            }
            [courses] > div > span[credit] {
                font-size: x-small;
            }
            [courses] > div > span[cost] {
                font-size: x-small;
                float: left;
            }
            [courses] > div > span[professor] {
                font-size: x-small;
            }
            [courses] > div:is([landed]) > span[credit] {
                display: none;
            }
            [courses] > div:is([landed]) > span[cost] {
                display: none;
            }
            [courses] > div:not([landed]) > span[professor] {
                display: none;
            }
            [courses] > div.ui-draggable.ui-draggable-dragging {
                width: 100px;
            }
            [courses].ui-droppable-active > div[landed].ui-draggable:not(.ui-draggable-dragging) {
                opacity: 0.3;
            }
            [courses] > div.ui-draggable.ui-draggable-dragging > span[credit] {
                display: none;
            }
            [courses] > div.ui-draggable.ui-draggable-dragging > span[cost] {
                display: none;
            }
        .ui-droppable.ui-droppable-hover {
            box-shadow: 2px 2px 4px #aaa !important;
            border-width: 3px !important;
        }        
    </style>
</body>
</html>